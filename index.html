<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            font-size: small;
        }
        #imageContainer {
            width: 100%;
            height: auto;
        }
        #imageContainer img {
            width: 100%;
            height: auto;
        }
        #palette-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            margin: 10px;
        }
        .paletteColor {
            width: 30px;
            height: 30px;
        }
        .picker {
            border-radius: 15px;
        }
        #tools {
            position: fixed;
            background-color: white;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="tools">
        <form id="form1">
            <input type="file" id="imageUpload" accept="image/*">
            <!--
            <select id="select-img">
                <optgroup label="Agriculture">
                    <option>Baja_California_Mexico.jpg</option>
                    <option>Palm_oil_plantations.jpg</option>
                    <option>Ries_crater_Germany.jpg</option>
                    <option>South_Kalimantan_Borneo.jpg</option>
                    <option>Hereford_Texas.jpg</option>
                    <option>Rice_fields_Vietnam.jpg</option>
                    <option>Sindh_Pakistan.jpg</option>
                    <option>Washington_US.jpg</option>
                    </optgroup>
                    <optgroup label="Coastal Zones">
                    <option>Abu_Dhabi.jpg</option>
                    <option>English_Channel.jpg</option>
                    <option>San_Francisco_Bay.jpg</option>
                    <option>Barranquilla_Colombia.jpg</option>
                    <option>Gulf_of_Kutch_India.jpg</option>
                    <option>Scandinavian_snows_highlight_std.jpg</option>
                    <option>Bouches-du-Rhone_France.jpg</option>
                    <option>Gulf_of_Taranto_Italy.jpg</option>
                    <option>Western_Pakistan.jpg</option>
                    <option>Clarence_Strait_Australia.jpg</option>
                    <option>Montevideo_Uruguay.jpg</option>
                    </optgroup>
                    <optgroup label="Deserts">
                    <option>Namib_Desert.jpg</option>
                    <option>Namib_Desert_pillars.jpg</option>
                    <option>Rub_al_Khali_desert_highlight_std.jpg</option>
                    </optgroup>
                    <optgroup label="Glaciers">
                    <option>Glacier_Bay_Alaska.jpg</option>
                    <option>Northwest_Greenland.jpg</option>
                    <option>Vatnajoekull_Iceland.jpg</option>
                    <option>Melt_Ponds_in_West_Greenland.jpg</option>
                    <option>Svalbard.jpg</option>
                    </optgroup>
                    <optgroup label="Lakes">
                    <option>Alberta_Canada.jpg</option>
                    <option>Lake_Balkhash_Kazakhastan.jpg</option>
                    <option>Lake_Trasimeno_Italy.jpg</option>
                    <option>Lake_Balaton_Hungary.jpg</option>
                    <option>Lake_Chad_s_shrinking_waters.gif</option>
                    <option>Utah_s_Great_Salt_Lake.jpg</option>
                    </optgroup>
                    <optgroup label="Marine">
                    <option>Ari_Atoll_Maldives.jpg</option>
                    <option>Patagonia.jpg</option>
                    <option>Earth_from_Space_Blooms_in_the_Gulf_of_Finland.jpg</option>
                    <option>Queensland_floods.jpg</option>
                    <option>Great_Bahamas_Bank.jpg</option>
                    <option>Singapore.jpg</option>
                    <option>Irminger_Sea_ice_swirl.jpg</option>
                    <option>Tarawa_Kiribati.jpg</option>
                    <option>New_Zealand.jpg</option>
                    </optgroup>
                    <optgroup label="Mountains">
                    <option>Flinders_Ranges_South_Australia.jpg</option>
                    <option>Snowy_Pyrenees.jpg</option>
                    <option>Ulan_Bator_Mongolia.jpg</option>
                    <option>Peruvian_Andes.jpg</option>
                    <option>The_Alps.jpg</option>
                    </optgroup>
                    <optgroup label="Rivers">
                    <option>Amazon_River.jpg</option>
                    <option>Earth_from_Space_Bentiu_South_Sudan.jpg</option>
                    <option>Meeting_of_waters.jpg</option>
                    <option>Cambodian_rivers.jpg</option>
                    <option>Ganges_dazzling_delta_pillars.jpg</option>
                    <option>Mississippi_River.jpg</option>
                    <option>Colourful_Queensland_Australia.jpg</option>
                    <option>Lena_River_Delta.jpg</option>
                    <option>Nushagak_Bay_Alaska.jpeg</option>
                    </optgroup>
                    <optgroup label="Urban">
                    <option>Barcelona_Spain.jpg</option>
                    <option>Earth_from_Space_New_York.jpg</option>
                    <option>New_York_City.jpg</option>
                    <option>Bonn_Germany.jpg</option>
                    <option>Milan_Italy.jpg</option>
                    <option>Santiago_Chile.jpg</option>
                    <option>Brussels.jpg</option>
                    <option>Nairobi_Kenya.jpg</option>
                    <option>Tokyo_Bay_Japan.jpg</option>
                    </optgroup>
                    <optgroup label="Volcanoes">
                    <option>Castelli_Romani_Italy.jpg</option>
                    <option>East_Bali_Indonesia.jpg</option>
                    <option>Mount_Aso_Japan.jpg</option>
                    <option>Mount_Fuji_Japan.jpg</option>
                    </optgroup>

            </select>
            -->
            Color area size: <input type="number" id="areaSize" min="1" placeholder="1" value="1">
            <div id="palette-container">
                <table id="palette">
                    <tr>
                        <td id="hoveredColor" class="paletteColor picker"></td>
                        <td id="averageColor" class="paletteColor picker"></td>
                    </tr>
                </table>

                <table id="palette">
                    <tr id="palette-row">
                        <td class="paletteColor"></td>
                        <td class="paletteColor"></td>
                        <td class="paletteColor"></td>
                        <td class="paletteColor"></td>
                    </tr>
                </table>
            </div>
        </form>
    </div>
    <div id="imageContainer"></div>
    <!--
    <div id="hoveredColor" style="position: fixed; top: 0; left: 0; width: 50px; height: 50px;"></div>
    <div id="averageColor" style="position: fixed; top: 60px; left: 0; width: 50px; height: 50px;"></div>
    -->
    <script src="colorConvert.min.js"></script>
    <script src="color-thief.min.js"></script>
    <script src="Tone.js"></script>
    <script>

var numWaves = 8;
let row = document.getElementById("palette-row");

// Determine the starting index for the new cells
// Create and insert new cells
for (let i = 0; i < numWaves; i++) {
    let cell = row.insertCell(-1);
    cell.className = "paletteColor";
    cell.id = "color-" + (i);
}

document.getElementById('imageUpload').addEventListener('change', function(e) {
    loadImage(e);
});


function loadImage(e) {
    var reader = new FileReader();
    reader.onload = function(event) {
        var img = new Image();
        img.setAttribute('id', 'img');
        img.onload = function() {
            //document.getElementById("form1").style.display = "none";
            document.getElementById('imageContainer').innerHTML = '';
            document.getElementById('imageContainer').appendChild(img);

            var canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            var context = canvas.getContext('2d', { willReadFrequently: true });
            context.drawImage(img, 0, 0, img.width, img.height);


            
            var isDragging = false;
            img.addEventListener('mousedown', function(e) {
                isDragging = true;
                //e.preventDefault();
            });

            img.addEventListener('mouseup', function(e) {
                isDragging = false;
                rOsc.volume.rampTo(-100, 2);
            });

            var rOsc = new Tone.Oscillator(0, "sine").toDestination().start();

            img.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                e.preventDefault();
                var {rgb, hsl} = getColorData(context, e, this);
                var [frequency, volume, attack, filterF] = hsl2osc(hsl);
                rOsc.frequency.rampTo(frequency);
                rOsc.volume.rampTo( 20*Math.log10(volume), 0.5 );
            });

            const colorThief = new ColorThief();
            //const img = document.querySelector('img');

            var domColor = colorThief.getColor(img);
            var palette = colorThief.getPalette(img, numWaves);
            console.log(palette.length);
            for (var i = 0; i < palette.length; i++) {
                document.getElementById('color-' + i).style.backgroundColor = 'rgb(' + palette[i][0] + ',' + palette[i][1] + ',' + palette[i][2] + ')';
                var hslTmp = colorConvert.rgb2hsl(palette[i][0], palette[i][1], palette[i][2]);
                var [frequency, volume, attack, filterF] = hsl2osc(hslTmp);
                ambOsc[i].frequency.value = frequency;
                ambOsc[i].volume.rampTo( 20*Math.log10(volume/(numWaves*1.5)) , 2) ;
                ambOsc[i].toDestination().start();
            }
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(e.target.files[0]);
}


function mapNumber(number, inMin, inMax, outMin, outMax) {
    return (number - inMin) * (outMax - outMin) / (inMax - inMin) + outMin;
}

function getColorData(context, e, img) {
                
    var pixelData = context.getImageData(e.offsetX, e.offsetY, 1, 1).data;
    
    var areaSize = parseInt(document.getElementById('areaSize').value);
    var totalR = 0, totalG = 0, totalB = 0, totalA = 0, totalPixels = 0;
    for (var y = Math.max(0, e.offsetY - areaSize); y <= Math.min(img.height - 1, e.offsetY + areaSize); y++) {
        for (var x = Math.max(0, e.offsetX - areaSize); x <= Math.min(img.width - 1, e.offsetX + areaSize); x++) {
            var areaPixelData = context.getImageData(x, y, 1, 1).data;
            totalR += areaPixelData[0];
            totalG += areaPixelData[1];
            totalB += areaPixelData[2];
            totalA += areaPixelData[3];
            totalPixels++;
        }
    }
    var pixelColor = 'rgba(' + pixelData[0] + ',' + pixelData[1] + ',' + pixelData[2] + ',' + pixelData[3] + ')';
    var averageColor = 'rgba(' + Math.round(totalR / totalPixels) + ',' + Math.round(totalG / totalPixels) + ',' + Math.round(totalB / totalPixels) + ',' + Math.round(totalA / totalPixels) + ')';
    document.getElementById('hoveredColor').style.backgroundColor = pixelColor;
    document.getElementById('averageColor').style.backgroundColor = averageColor;
    var rgb = [parseInt(totalR / totalPixels), parseInt(totalG / totalPixels), parseInt(totalB / totalPixels)];
    var cc = window.colorConvert;
    var hsl = cc.rgb2hsl(totalR / totalPixels, totalG / totalPixels, totalB / totalPixels);
    return({rgb: rgb, hsl: hsl});
}

function hsl2osc(hsl) {
    const pitches = [16.35, 17.32, 18.35, 19.45, 20.60, 21.83, 23.12, 24.50, 25.96, 27.50, 29.14, 30.87, 32.70];
    var pitch = pitches[Math.round(hsl[0]/30)];
    var octIndex = Math.floor((hsl[1]/25));
    var oct = Math.pow(2, octIndex)*4*Math.sign(hsl[1]);
    return [pitch*oct, hsl[2]/100, 0.1, 10000];
}

var ambOsc = [];
for (var i = 0; i < numWaves; i++) {
	const panner = new Tone.Panner(1).toDestination();
    if(i%2 == 0)
        panner.pan.value = mapNumber(i, 0, (numWaves-1), 0, 1);
    else
        panner.pan.value = mapNumber(i, 0, (numWaves-1), 0, -1);
	ambOsc[i] = new Tone.Oscillator(0, "sine").connect(panner);
    ambOsc[i].volume.value = -100;

/*
    if(i%2 == 0)
        ambOsc[i].setPan(mapNumber(i, 0, 7, 0, 1));
    else
        ambOsc[i].setPan(mapNumber(i, 0, 7, 0, -1));
*/

}

    </script>
</body>
</html>